# ---- Project And C++ ----
cmake_minimum_required(VERSION 3.21)
project(RadCat VERSION 0.1 LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# ---- Output directories ----
set(DIST_DIR "${CMAKE_SOURCE_DIR}/dist")
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/dist)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(APP_ICON_RESOURCE "${CMAKE_CURRENT_SOURCE_DIR}/res/radcat.rc")
foreach(cfg IN ITEMS Debug Release RelWithDebInfo MinSizeRel)
    string(TOUPPER "${cfg}" CFG_UP)
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_${CFG_UP} "${DIST_DIR}")
    set(CMAKE_LIBRARY_OUTPUT_DIRECTORY_${CFG_UP} "${DIST_DIR}/lib")
    set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY_${CFG_UP} "${DIST_DIR}/lib")
endforeach()

# ---- Collect all source files ----
file(GLOB_RECURSE SRC_FILES CONFIGURE_DEPENDS
    "${CMAKE_SOURCE_DIR}/src/*.cpp"
    "${CMAKE_SOURCE_DIR}/src/*.h"
)

# ---- Create executable target ----
if(WIN32)
    add_executable(${PROJECT_NAME} ${SRC_FILES} ${APP_ICON_RESOURCE})
else()
    add_executable(${PROJECT_NAME} ${SRC_FILES})
endif()

# ---- Include directories ----
target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/src/Devices
    ${CMAKE_SOURCE_DIR}/src/Devices/DeviceCoreSystems
    ${CMAKE_SOURCE_DIR}/src/Components
    ${CMAKE_SOURCE_DIR}/src/CompHandlers
    ${CMAKE_SOURCE_DIR}/src/UI
)

# ---- For Mac Whatever ----
if (APPLE)
    set(CMAKE_OSX_DEPLOYMENT_TARGET "14.0" CACHE STRING "Minimum OS X deployment version" FORCE)
    
    
endif()

# ---- Get Platform and platform specific includes ----
if (WIN32)
    target_compile_definitions(${PROJECT_NAME} PRIVATE PLATFORM_WINDOWS)
    target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/src/Included/Windows)
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/libs/ftd2xx.lib) # Link FTDI
    target_link_libraries(${PROJECT_NAME} PRIVATE ws2_32) # Link Winsock
    target_link_libraries(${PROJECT_NAME} PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/libs/libusb-1.0.lib") # Link libusb
elseif (APPLE)
    target_compile_definitions(${PROJECT_NAME} PRIVATE PLATFORM_MACOS)
    target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/src/Included/Mac)
    target_link_libraries(${PROJECT_NAME} PRIVATE "${CMAKE_SOURCE_DIR}/libs/libftd2xx.dylib") # Link FTDI
else()
    target_compile_definitions(${PROJECT_NAME} PRIVATE PLATFORM_LINUX)
    target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/src/Included/Linux)
    target_link_libraries(${PROJECT_NAME} PRIVATE "${CMAKE_SOURCE_DIR}/libs/libftd2xx.so") # Link FTDI
endif()

# ---- Dependencies / LIBRARIES ----

# ---- Post-build: copy FTDI runtime on Windows into dist ----
if (WIN32)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E make_directory "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${CMAKE_SOURCE_DIR}/Dlls/FTD2XX.dll"
            "$<TARGET_FILE_DIR:${PROJECT_NAME}>/FTD2XX.dll")
endif()

    ## --- Qt ---
    set(QT_REQUIRED_COMPONENTS Core Gui Widgets Qml Quick)
    find_package(Qt6 REQUIRED COMPONENTS ${QT_REQUIRED_COMPONENTS})
    qt_add_resources(RCC_SOURCES res/QTResources.qrc)
    target_link_libraries(${PROJECT_NAME} PRIVATE Qt6::Core Qt6::Gui Qt6::Widgets Qt6::Qml Qt6::Quick)
    target_sources(${PROJECT_NAME} PRIVATE ${RCC_SOURCES})
    set(QT_QML_GENERATE_QMLLS_INI ON)

    qt_add_qml_module(${PROJECT_NAME}
        URI RadCat
        VERSION 1.0
        QML_FILES
            
    )

    ## --- ROOT ---
    find_package(ROOT REQUIRED)
    target_include_directories(${PROJECT_NAME} PRIVATE ${ROOT_INCLUDE_DIRS})
    target_link_libraries(${PROJECT_NAME} PRIVATE ${ROOT_LIBRARIES})

# ---- Compiler warnings ----
if (MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE /W4 /permissive- /wd4100 /wd4189)
    # /wd4100 -> unreferenced formal parameter
    # This happens when a function has a parameter that is never used in its body.
    # /wd4189 -> local variable is initialized but not referenced
    # This happens when you create a local variable, give it a value, but never use it.
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -Wall -Wextra -pedantic -Wno-unused-parameter -Wno-unused-variable -Wno-pedantic)
endif()

set(CMAKE_EXPORT_COMPILE_COMMANDS ON) # IDE